"""Reward calculations for extrinsic and intrinsic signals."""
from __future__ import annotations

import math
from typing import Dict, Iterable

DEFAULT_BETA = 0.3


class RewardCalculator:
    def __init__(self, beta: float = DEFAULT_BETA) -> None:
        self.beta = beta
        self.combo_counts: Dict[str, int] = {}

    def external_reward(
        self,
        combo_key: str,
        syntax_error: bool,
        crash_error: bool,
        kk_updated: Iterable[str],
        flag_found: bool,
    ) -> float:
        reward = 0.0
        # Curiosity reward for executing a command (discounted if repeated)
        count = self.combo_counts.get(combo_key, 0) + 1
        self.combo_counts[combo_key] = count
        reward += 1 / math.sqrt(count)

        if syntax_error:
            reward -= 5.0
        elif crash_error:
            reward -= 2.0

        if flag_found:
            reward += 50.0

        if any(kk_updated):
            reward += 2.0

        return reward

    def intrinsic_reward(self, loss: float) -> float:
        return self.beta * math.tanh(loss)

    def total_reward(self, ext: float, intrinsic: float) -> float:
        return ext + intrinsic

    def reset_episode(self) -> None:
        self.combo_counts.clear()
