"""Practice executor with deterministic outputs per tool."""
from __future__ import annotations

import json
import shlex
from typing import Dict, Tuple


SCHEMA_VERSION = "webtool-v1"


def practice_executor(command: str) -> Tuple[str, bool]:
    tokens = shlex.split(command, posix=False)
    if not tokens:
        return "", True
    if tokens[0] == "pytool":
        tool_name = tokens[1] if len(tokens) > 1 else ""
        payload = _practice_payload(tool_name)
        return json.dumps(payload, ensure_ascii=True), False
    if tokens[0] == "curl":
        return _practice_headers(), False
    if tokens[0] == "nmap":
        return _practice_nmap_xml(), False
    return "", True


def _practice_payload(tool_name: str) -> Dict[str, object]:
    if tool_name == "http-fetch":
        return _schema_response(
            observations={
                "http_status": [200, 302],
                "headers_present": ["Location", "Set-Cookie", "Server"],
                "forms_detected": True,
                "params_detected": ["id", "q"],
                "redirect_depth": 1,
                "title": "Practice Portal",
                "content_type": "text/html",
                "content_length": 4200,
                "body_sha1": "deadbeef",
                "body_snippet": "practice snippet",
            },
            artifacts={
                "urls": ["/", "/login", "/admin", "/vault"],
                "params": ["id", "q"],
                "cookies": ["session"],
                "set_cookies": ["session=abc123"],
            },
            cost={"requests": 2, "time_ms": 150, "errors": 0},
            safety={"scope_violation": False, "blocked": False},
        )
    if tool_name == "robots-sitemap":
        return _schema_response(
            observations={
                "http_status": [200],
                "headers_present": [],
                "forms_detected": False,
                "params_detected": ["page"],
                "redirect_depth": 0,
            },
            artifacts={
                "urls": ["/robots.txt", "/sitemap.xml", "/admin", "/hidden"],
                "params": ["page"],
                "cookies": [],
                "robots_disallow": ["/admin", "/hidden"],
                "robots_allow": ["/"],
                "sitemap_urls": ["http://127.0.0.1:8000/login"],
                "sitemap_paths": ["/login"],
            },
            cost={"requests": 2, "time_ms": 120, "errors": 0},
            safety={"scope_violation": False, "blocked": False},
        )
    if tool_name == "html-crawler":
        return _schema_response(
            observations={
                "http_status": [200],
                "headers_present": ["Content-Type"],
                "forms_detected": True,
                "params_detected": ["user", "file"],
                "redirect_depth": 0,
            },
            artifacts={
                "urls": ["/", "/login", "/search", "/api/status"],
                "params": ["user", "file"],
                "cookies": [],
                "links": ["/login", "/search"],
                "forms": ["/login"],
                "scripts": ["/static/app.js"],
                "js_endpoints": ["/api/status", "/api/admin"],
            },
            cost={"requests": 3, "time_ms": 200, "errors": 0},
            safety={"scope_violation": False, "blocked": False},
        )
    if tool_name == "dir-enum":
        return _schema_response(
            observations={
                "http_status": [200, 301, 403],
                "headers_present": [],
                "forms_detected": False,
                "params_detected": [],
                "redirect_depth": 0,
            },
            artifacts={
                "urls": ["/admin", "/backup", "/status"],
                "params": [],
                "cookies": [],
                "found": [
                    {"path": "/admin", "status": 403},
                    {"path": "/backup", "status": 200},
                    {"path": "/status", "status": 200},
                ],
            },
            cost={"requests": 15, "time_ms": 350, "errors": 0},
            safety={"scope_violation": False, "blocked": False},
        )
    if tool_name == "hint-scanner":
        return _schema_response(
            observations={
                "http_status": [200],
                "headers_present": ["Set-Cookie"],
                "forms_detected": False,
                "params_detected": ["next"],
                "redirect_depth": 0,
                "body_snippet": "token=TOKEN{practice}",
            },
            artifacts={
                "urls": ["/vault"],
                "params": ["next"],
                "cookies": ["session"],
                "hints": ["keyword:token", "comment:practice hint"],
                "keywords": ["token"],
                "comments": ["practice hint"],
            },
            cost={"requests": 1, "time_ms": 90, "errors": 0},
            safety={"scope_violation": False, "blocked": False},
        )
    if tool_name == "stateful-http":
        return _schema_response(
            observations={
                "http_status": [200, 302],
                "headers_present": ["Set-Cookie", "Location"],
                "forms_detected": True,
                "params_detected": ["username", "password"],
                "redirect_depth": 1,
            },
            artifacts={
                "urls": ["/login", "/dashboard"],
                "params": ["username", "password"],
                "cookies": ["session"],
                "set_cookies": ["session=xyz"],
                "cookies_sent": ["session"],
            },
            cost={"requests": 2, "time_ms": 140, "errors": 0},
            safety={"scope_violation": False, "blocked": False},
        )
    if tool_name == "param-influence":
        return _schema_response(
            observations={
                "http_status": [200, 500],
                "headers_present": [],
                "forms_detected": False,
                "params_detected": ["id", "file"],
                "redirect_depth": 0,
                "response_variance": 0.3,
                "status_variance": True,
                "error_disclosure": True,
                "input_output_coupling": True,
            },
            artifacts={
                "urls": [],
                "params": ["id", "file"],
                "cookies": [],
                "param_variance": [
                    {"param": "id", "len_a": 1200, "len_b": 1600, "variance": 0.25},
                    {"param": "file", "len_a": 800, "len_b": 1400, "variance": 0.3},
                ],
            },
            cost={"requests": 5, "time_ms": 260, "errors": 0},
            safety={"scope_violation": False, "blocked": False},
        )

    return _schema_response(
        observations={
            "http_status": [200],
            "headers_present": [],
            "forms_detected": False,
            "params_detected": [],
            "redirect_depth": 0,
        },
        artifacts={"urls": [], "params": [], "cookies": []},
        cost={"requests": 1, "time_ms": 50, "errors": 0},
        safety={"scope_violation": False, "blocked": False},
    )


def _schema_response(
    observations: Dict[str, object],
    artifacts: Dict[str, object],
    cost: Dict[str, int],
    safety: Dict[str, bool],
) -> Dict[str, object]:
    return {
        "schema_version": SCHEMA_VERSION,
        "ok": True,
        "error": None,
        "observations": observations,
        "artifacts": artifacts,
        "cost": cost,
        "safety": safety,
    }


def _practice_headers() -> str:
    return (
        "HTTP/1.1 302 Found\r\n"
        "Location: /login\r\n"
        "Set-Cookie: session=abc\r\n"
        "X-Next: /vault\r\n"
        "\r\n"
    )


def _practice_nmap_xml() -> str:
    return (
        "<nmaprun>"
        "<host><status state='up'/>"
        "<address addr='127.0.0.1'/>"
        "<ports>"
        "<port protocol='tcp' portid='80'>"
        "<state state='open'/>"
        "<service name='http' version='1.0'/>"
        "</port>"
        "</ports>"
        "</host>"
        "</nmaprun>"
    )
