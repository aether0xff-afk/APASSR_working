"""Metrics for HTB-style evaluation (observation-based)."""
from __future__ import annotations

from typing import Dict, List

from pentesting_rl.state_model import estimate_info_gain, extract_step_paths, state_signature


DEEP_STATE_KEYWORDS = ["admin", "vault", "internal", "api", "private", "secret"]


def compute_metrics(
    history: List[Dict[str, object]],
    knowledge_store: Dict[str, List[str]],
    window: int = 5,
) -> Dict[str, object]:
    total_gain = 0
    total_requests = 0
    seen_paths: set[str] = set()
    seen_params: set[str] = set()
    seen_cookies: set[str] = set()

    steps_to_first_transition = None
    steps_to_deep_state = None
    prev_state_id = None

    for idx, transition in enumerate(history):
        cost = transition.get("s_t", {}).get("cost", {}) or {}
        total_requests += int(cost.get("requests", 0) or 0)

        gain, _, _, _ = estimate_info_gain(transition, seen_paths, seen_params, seen_cookies)
        total_gain += gain

        state_id, _ = state_signature(history, idx, window=window)
        if prev_state_id is None:
            prev_state_id = state_id
        elif steps_to_first_transition is None and state_id != prev_state_id:
            steps_to_first_transition = _step_index(transition, idx)
            prev_state_id = state_id
        else:
            prev_state_id = state_id

        if steps_to_deep_state is None:
            paths = extract_step_paths(transition)
            if _is_deep_state(paths):
                steps_to_deep_state = _step_index(transition, idx)

    ig_per_request = None
    if total_requests > 0:
        ig_per_request = total_gain / float(total_requests)

    endpoints = _unique_from_store(
        knowledge_store,
        [
            "PATH_HINT",
            "LINK_FOUND",
            "FORM_ACTION",
            "SCRIPT_SRC",
            "JS_ENDPOINT",
            "ROBOTS_DISALLOW",
            "ROBOTS_ALLOW",
            "SITEMAP_URL",
        ],
    )
    params = _unique_from_store(knowledge_store, ["PARAM_DETECTED"])
    cookies = _unique_from_store(knowledge_store, ["COOKIE_SEEN", "HTTP_SET_COOKIE"])

    return {
        "ig_per_request": ig_per_request,
        "total_info_gain": total_gain,
        "total_requests": total_requests,
        "discovered_endpoints": len(endpoints),
        "discovered_params": len(params),
        "discovered_cookies": len(cookies),
        "steps_to_first_transition": steps_to_first_transition,
        "steps_to_deep_state": steps_to_deep_state,
    }


def _unique_from_store(store: Dict[str, List[str]], keys: List[str]) -> List[str]:
    values: set[str] = set()
    for key in keys:
        for value in store.get(key, []) or []:
            values.add(str(value))
    return sorted(values)


def _is_deep_state(paths: List[str]) -> bool:
    for path in paths:
        lowered = path.lower()
        if any(keyword in lowered for keyword in DEEP_STATE_KEYWORDS):
            return True
    return False


def _step_index(transition: Dict[str, object], fallback: int) -> int:
    meta = transition.get("meta", {}) or {}
    step = meta.get("step")
    if isinstance(step, int):
        return step
    return fallback
